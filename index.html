import React, { useState, useEffect, useRef } from 'react';
import { 
  Settings, 
  Send, 
  MessageSquare, 
  BookOpen, 
  History, 
  Trash2, 
  ShieldCheck, 
  AlertCircle,
  Menu,
  X
} from 'lucide-react';

const App = () => {
  // State Management
  const [apiKey, setApiKey] = useState(() => localStorage.getItem('gemini_api_key') || '');
  const [showSettings, setShowSettings] = useState(false);
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState('');
  const [loading, setLoading] = useState(false);
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const scrollRef = useRef(null);

  // Auto-scroll to bottom of chat
  useEffect(() => {
    if (scrollRef.current) {
      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
    }
  }, [messages]);

  // System Prompt including the "2 AM Robot Recovery" script
  const systemPrompt = `You are a Senior BCBA (Board Certified Behavior Analyst) Consultant. 
Your goal is to provide evidence-based, clinically sound advice following ABA ethical guidelines.
Persona: Professional, supportive, analytical, and highly experienced.

IMPORTANT PROTOCOL:
If a user mentions sleep issues, night-time routines, or '2 AM' struggles, you MUST incorporate the '2 AM Robot Recovery' script:
- Remain neutral and "boring" (robot-like).
- Minimize eye contact and verbal interaction.
- Use a calm, monotone voice for necessary prompts only.
- Guide the learner back to bed with minimal physical prompting.
- Avoid reinforcing the wakeful behavior with attention or preferred items.

When providing advice, always prioritize safety, data-based decision making, and the dignity of the learner.`;

  const handleSend = async () => {
    if (!input.trim()) return;
    if (!apiKey) {
      setShowSettings(true);
      return;
    }

    const userMessage = { role: 'user', content: input };
    setMessages(prev => [...prev, userMessage]);
    setInput('');
    setLoading(true);

    try {
      const response = await fetchWithRetry(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [
              { parts: [{ text: systemPrompt }] }, // System Context
              ...messages.map(m => ({
                role: m.role === 'user' ? 'user' : 'model',
                parts: [{ text: m.content }]
              })),
              { role: 'user', parts: [{ text: input }] }
            ]
          })
        }
      );

      const data = await response.json();
      const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "I'm sorry, I couldn't process that request.";
      
      setMessages(prev => [...prev, { role: 'model', content: aiText }]);
    } catch (error) {
      setMessages(prev => [...prev, { role: 'error', content: "Connection Error: Please check your API key and internet connection." }]);
    } finally {
      setLoading(false);
    }
  };

  const fetchWithRetry = async (url, options, retries = 5, backoff = 1000) => {
    try {
      const res = await fetch(url, options);
      if (!res.ok) throw new Error();
      return res;
    } catch (err) {
      if (retries <= 0) throw err;
      await new Promise(r => setTimeout(r, backoff));
      return fetchWithRetry(url, options, retries - 1, backoff * 2);
    }
  };

  const saveSettings = (e) => {
    e.preventDefault();
    localStorage.setItem('gemini_api_key', apiKey);
    setShowSettings(false);
  };

  const clearChat = () => {
    if (confirm("Clear this clinical session?")) {
      setMessages([]);
    }
  };

  return (
    <div className="flex h-screen bg-slate-50 font-sans text-slate-900">
      {/* Mobile Sidebar Toggle */}
      <button 
        onClick={() => setSidebarOpen(!sidebarOpen)}
        className="lg:hidden fixed top-4 left-4 z-50 p-2 bg-white rounded shadow-md"
      >
        {sidebarOpen ? <X size={20} /> : <Menu size={20} />}
      </button>

      {/* Sidebar */}
      <aside className={`
        fixed inset-y-0 left-0 z-40 w-64 bg-slate-900 text-white transform transition-transform duration-300 lg:relative lg:translate-x-0
        ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'}
      `}>
        <div className="p-6">
          <div className="flex items-center gap-2 mb-8">
            <div className="p-2 bg-blue-500 rounded-lg">
              <ShieldCheck size={24} />
            </div>
            <h1 className="text-xl font-bold tracking-tight">BCBA Assistant</h1>
          </div>

          <nav className="space-y-4">
            <button className="flex items-center gap-3 w-full p-2 rounded hover:bg-slate-800 transition text-slate-300">
              <MessageSquare size={18} />
              <span>Current Session</span>
            </button>
            <button className="flex items-center gap-3 w-full p-2 rounded hover:bg-slate-800 transition text-slate-300 opacity-50 cursor-not-allowed">
              <History size={18} />
              <span>Case History</span>
            </button>
            <button className="flex items-center gap-3 w-full p-2 rounded hover:bg-slate-800 transition text-slate-300 opacity-50 cursor-not-allowed">
              <BookOpen size={18} />
              <span>Reference Library</span>
            </button>
          </nav>
        </div>

        <div className="absolute bottom-0 w-full p-4 border-t border-slate-800">
          <button 
            onClick={() => setShowSettings(true)}
            className="flex items-center gap-3 w-full p-2 rounded hover:bg-slate-800 transition text-slate-300"
          >
            <Settings size={18} />
            <span>Settings</span>
          </button>
        </div>
      </aside>

      {/* Main Chat Area */}
      <main className="flex-1 flex flex-col relative w-full overflow-hidden">
        {/* Header */}
        <header className="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 shrink-0">
          <div className="flex flex-col">
            <span className="text-sm font-semibold text-slate-700">Senior Consultant Mode</span>
            <span className="text-xs text-green-500 flex items-center gap-1">
              <span className="w-2 h-2 bg-green-500 rounded-full"></span> Active Session
            </span>
          </div>
          <button 
            onClick={clearChat}
            className="p-2 text-slate-400 hover:text-red-500 transition"
            title="Clear Session"
          >
            <Trash2 size={20} />
          </button>
        </header>

        {/* Messages */}
        <div 
          ref={scrollRef}
          className="flex-1 overflow-y-auto p-4 md:p-8 space-y-6"
        >
          {messages.length === 0 && (
            <div className="flex flex-col items-center justify-center h-full text-center space-y-4 max-w-md mx-auto">
              <div className="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center">
                <MessageSquare size={32} />
              </div>
              <h2 className="text-xl font-bold">Clinical Case Assistant</h2>
              <p className="text-slate-500">
                Describe a scenario, ABC data, or a behavior concern. I'll provide analysis and evidence-based interventions.
              </p>
              <div className="grid grid-cols-1 gap-2 w-full mt-4">
                <button 
                  onClick={() => setInput("The learner is engaging in hand-flapping, what should I do?")}
                  className="text-left p-3 border border-slate-200 rounded-lg hover:bg-white hover:border-blue-300 transition text-sm"
                >
                  "How should I handle stereotypy?"
                </button>
                <button 
                  onClick={() => setInput("Can you help me with a 2 AM wake up situation?")}
                  className="text-left p-3 border border-slate-200 rounded-lg hover:bg-white hover:border-blue-300 transition text-sm"
                >
                  "We have 2 AM wake-ups..."
                </button>
              </div>
            </div>
          )}

          {messages.map((m, i) => (
            <div key={i} className={`flex ${m.role === 'user' ? 'justify-end'

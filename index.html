import React, { useState, useEffect, useRef } from 'react';
import { Lightbulb, Send, ShieldCheck, Lock, AlertCircle, RefreshCcw, LogOut, Settings, X, CheckCircle2 } from 'lucide-react';

const App = () => {
  // --- PRODUCTION CONFIG ---
  const CLINIC_CODE = "ABA2024"; 
  
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [authInput, setAuthInput] = useState('');
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [showSettings, setShowSettings] = useState(false);
  const [apiKey, setApiKey] = useState(localStorage.getItem('rbt_api_key') || "");
  
  const scrollRef = useRef(null);

  useEffect(() => {
    if (scrollRef.current) {
      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
    }
  }, [messages]);

  const saveSettings = (e) => {
    e.preventDefault();
    localStorage.setItem('rbt_api_key', apiKey);
    setShowSettings(false);
  };

  const handleLogin = (e) => {
    e.preventDefault();
    if (authInput === CLINIC_CODE) {
      setIsAuthenticated(true);
      setError(null);
    } else {
      setError("Invalid Clinic Access Code");
    }
  };

  const generateResponse = async (userPrompt) => {
    if (!apiKey) {
      setError("API Key missing. Click the gear icon to set it up.");
      return;
    }

    setLoading(true);
    setError(null);

    const systemPrompt = `You are a Senior BCBA Consultant. Provide immediate, evidence-based ABA strategies.
    SCENARIOS:
    - Include the '2 AM Robot Recovery' protocol if user mentions sleep/night routines.
    RULES:
    1. STRICT PRIVACY: No PII. Use "the learner".
    2. Zero Retention: Do not acknowledge names.
    3. Clinical focus: Antecedents, Reinforcement, and De-escalation.
    4. Format: Bullet points for quick reading.`;

    const callApi = async (retryCount = 0) => {
      try {
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ parts: [{ text: userPrompt }] }],
              systemInstruction: { parts: [{ text: systemPrompt }] }
            }),
          }
        );

        if (!response.ok) {
          const errData = await response.json();
          throw new Error(errData.error?.message || 'API Error');
        }
        const data = await response.json();
        return data.candidates?.[0]?.content?.parts?.[0]?.text;
      } catch (err) {
        if (retryCount < 2) {
          await new Promise(res => setTimeout(res, 1000 * (retryCount + 1)));
          return callApi(retryCount + 1);
        }
        throw err;
      }
    };

    try {
      const text = await callApi();
      setMessages(prev => [...prev, { role: 'assistant', content: text }]);
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!input.trim()) return;
    const userMsg = { role: 'user', content: input };
    setMessages([...messages, userMsg]);
    generateResponse(input);
    setInput('');
  };

  if (!isAuthenticated) {
    return (
      <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
        <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md">
          <div className="flex justify-center mb-6">
            <div className="bg-blue-600 p-4 rounded-full text-white shadow-lg">
              <Lock size={32} />
            </div>
          </div>
          <h2 className="text-2xl font-bold text-center text-slate-800 mb-2">Clinic Portal</h2>
          <p className="text-center text-slate-500 mb-6 font-medium">Internal Use Only</p>
          
          <form onSubmit={handleLogin} className="space-y-4">
            <input
              type="password"
              value={authInput}
              onChange={(e) => setAuthInput(e.target.value)}
              placeholder="Access Code"
              className="w-full p-4 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-center text-lg tracking-widest"
              autoFocus
            />
            <button className="w-full bg-blue-600 text-white font-bold py-4 rounded-xl hover:bg-blue-700 transition-colors shadow-lg active:scale-[0.98]">
              Unlock Assistant
            </button>
            {error && <p className="text-red-500 text-center text-sm font-semibold">{error}</p>}
          </form>
        </div>
      </div>
    );
  }

  return (
    <div className="flex flex-col h-screen bg-slate-50 font-sans relative">
      {/* Settings Modal */}
      {showSettings && (
        <div className="absolute inset-0 z-50 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl">
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-bold text-slate-800">API Configuration</h3>
              <button onClick={() => setShowSettings(false)}><X size={20}/></button>
            </div>
            <p className="text-xs text-slate-500 mb-4">Paste your Google Cloud API Key here. It is saved locally on this device only.</p>
            <form onSubmit={saveSettings} className="space-y-4">
              <input 
                type="password" 
                value={apiKey} 
                onChange={(e) => setApiKey(e.target.value)}
                placeholder="AI API Key"
                className="w-full p-3 border rounded-xl text-sm"
              />
              <button className="w-full bg-slate-800 text-white py-3 rounded-xl font-bold text-sm">Save Locally</button>
            </form>
          </div>
        </div>
      )}

      <header className="bg-[#1e293b] text-white p-4 shadow-md flex justify-between items-center shrink-0">
        <div className="flex items-center gap-3">
          <div className="bg-blue-500 p-2 rounded-lg"><Lightbulb size={20} /></div>
          <div>
            <h1 className="font-bold text-lg leading-tight">RBT Strategy Finder</h1>
            <div className="flex items-center gap-1">
              <div className="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
              <p className="text-[10px] text-blue-300 uppercase tracking-widest font-bold">Secure Session</p>
            </div>
          </div>
        </div>
        <div className="flex gap-1 md:gap-2">
           <button onClick={() => setShowSettings(true)} className="p-2 hover:bg-slate-700 rounded-full text-slate-300"><Settings size={18} /></button>
           <button onClick={() => setMessages([])} className="p-2 hover:bg-slate-700 rounded-full text-slate-300" title="Clear Chat"><RefreshCcw size={18} /></button>
           <button onClick={() => setIsAuthenticated(false)} className="p-2 hover:bg-red-900/40 rounded-full text-red-300"><LogOut size={18} /></button>
        </div>
      </header>

      <div className="bg-blue-50 border-b border-blue-100 p-2 px-4 flex items-center justify-center gap-2 shrink-0">
        <ShieldCheck size={14} className="text-blue-600" />
        <p className="text-[10px] text-blue-800 font-bold uppercase tracking-wider">
          HIPAA Guard: Vertex AI + No Data Logging
        </p>
      </div>

      <div ref={scrollRef} className="flex-1 overflow-y-auto p-4 space-y-4 max-w-3xl mx-auto w-full">
        {messages.length === 0 && (
          <div className="flex flex-col items-center justify-center h-full text-center space-y-4 opacity-40 py-10 md:py-20">
            <div className="bg-slate-200 p-6 rounded-full"><Lightbulb size={40} className="text-slate-500" /></div>
            <div className="space-y-2">
              <p className="text-slate-600 font-bold uppercase text-xs tracking-widest">Awaiting Input</p>
              <p className="max-w-xs text-slate-500 text-sm">Describe the current antecedent or behavior for clinical suggestions.</p>
            </div>
          </div>
        )}

        {messages.map((m, i) => (
          <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
            <div className={`max-w-[85%] p-4 rounded-2xl shadow-sm ${
              m.role === 'user' ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white border border-slate-200 text-slate-800 rounded-tl-none'
            }`}>
              <div className="text-[15px] leading-relaxed whitespace-pre-wrap">{m.content}</div>
            </div>
          </div>
        ))}
        {loading && (
          <div className="flex gap-2 items-center ml-2">
            <div className="flex gap-1">
              <div className="w-1.5 h-1.5 bg-blue-400 rounded-full animate-bounce"></div>
              <div className="w-1.5 h-1.5 bg-blue-400 rounded-full animate-bounce [animation-delay:0.2s]"></div>
              <div className="w-1.5 h-1.5 bg-blue-400 rounded-full animate-bounce [animation-delay:0.4s]"></div>
            </div>
            <span className="text-[10px] text-slate-400 font-bold uppercase tracking-tighter">Analyzing...</span>
          </div>
        )}
        {error && (
          <div className="p-3 bg-red-50 border border-red-100 rounded-xl text-red-600 text-xs flex items-center gap-2">
            <AlertCircle size={14} /> {error}
          </div>
        )}
      </div>

      <div className="p-4 bg-white border-t border-slate-200 shrink-0">
        <form onSubmit={handleSubmit} className="max-w-3xl mx-auto flex gap-2">
          <input
            type="text"
            value={input}
            onChange={(e) => setInput(e.target.value)}
            placeholder="What's happening in the session?"
            className="flex-1 p-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none text-[15px] shadow-inner"
          />
          <button disabled={loading || !input.trim()} className="bg-blue-600 text-white p-4 rounded-2xl hover:bg-blue-700 disabled:opacity-30 shadow-lg active:scale-95 transition-all">
            <Send size={20} />
          </button>
        </form>
        <p className="text-center text-[9px] text-slate-400 mt-3 font-medium">
          Confidential Session. Do not input patient names or identifying information.
        </p>
      </div>
    </div>
  );
};

export default App;
